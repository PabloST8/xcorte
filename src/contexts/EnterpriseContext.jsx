import React, {
  createContext,
  useState,
  useContext,
  useEffect,
  useCallback,
} from "react";
import { publicEnterpriseFirestoreService } from "../services/publicEnterpriseFirestoreService";
import Cookies from "js-cookie";
import { useAuth } from "../hooks/useAuth";
import { useQueryClient } from "@tanstack/react-query";

const EnterpriseContext = createContext();

export const useEnterprise = () => {
  const context = useContext(EnterpriseContext);
  if (!context) {
    throw new Error(
      "useEnterprise deve ser usado dentro de EnterpriseProvider"
    );
  }
  return context;
};

export const EnterpriseProvider = ({ children }) => {
  const [currentEnterprise, setCurrentEnterprise] = useState(null);
  const [enterprises, setEnterprises] = useState([]);
  const [loading, setLoading] = useState(true);
  const { user } = useAuth();
  const queryClient = useQueryClient();

  // Email da empresa padr√£o - usando empresaadmin@xcortes.com
  const DEFAULT_ENTERPRISE_EMAIL = "empresaadmin@xcortes.com";

  useEffect(() => {
    loadEnterprises();
  }, []);

  // Sincronizar automaticamente quando o usu√°rio mudar
  useEffect(() => {
    if (
      enterprises.length > 0 &&
      user &&
      user.role === "admin" &&
      user.enterpriseEmail
    ) {
      console.log(
        "üîÑ Auto-sincronizando empresa com usu√°rio:",
        user.enterpriseEmail
      );
      syncEnterpriseWithUser(user);
    }
  }, [user, enterprises.length]);

  // Sincronizar automaticamente quando o usu√°rio mudar
  useEffect(() => {
    if (
      enterprises.length > 0 &&
      user &&
      user.role === "admin" &&
      user.enterpriseEmail
    ) {
      console.log(
        "üîÑ Auto-sincronizando empresa com usu√°rio:",
        user.enterpriseEmail
      );
      syncEnterpriseWithUser(user);
    }
  }, [user, enterprises]);

  const loadEnterprises = async () => {
    // Ap√≥s carregar as empresas, se j√° houver usu√°rio logado, sincroniza imediatamente
    if (user && user.enterpriseEmail) {
      const found = enterprises.find((e) => e.email === user.enterpriseEmail);
      if (found) {
        setCurrentEnterprise(found);
        Cookies.set("current_enterprise", JSON.stringify(found), {
          expires: 30,
        });
        console.log(
          "üîÑ Empresa sincronizada com usu√°rio ap√≥s carregar empresas:",
          found
        );
      }
    }
    try {
      setLoading(true);

      // USAR APENAS FIRESTORE - API desabilitada
      let enterprises = [];

      console.log("üîç Carregando APENAS do Firestore (API desabilitada)...");
      try {
        const firestoreEnterprises =
          await publicEnterpriseFirestoreService.getEnterprises();
        console.log("üìä Resposta do Firestore:", firestoreEnterprises);

        if (firestoreEnterprises && firestoreEnterprises.length > 0) {
          enterprises = firestoreEnterprises;
          console.log(
            "‚úÖ Empresas carregadas do Firestore:",
            enterprises.length
          );
          console.log(
            "üìã Empresas encontradas:",
            enterprises.map((e) => ({
              name: e.name,
              email: e.email,
              id: e.id,
            }))
          );
        } else {
          console.log("‚ö†Ô∏è Firestore retornou array vazio");
        }
      } catch (firestoreError) {
        console.warn("‚ö†Ô∏è Firestore falhou:", firestoreError);
      }

      // Se ainda n√£o tem empresas, usa dados de teste
      if (enterprises.length === 0) {
        console.log("üìã Usando empresas de teste como √∫ltimo recurso");
        enterprises = [
          {
            id: "pablofafstar@gmail.com",
            name: "Barbearia do Pablo",
            email: "pablofafstar@gmail.com",
            phone: "(11) 99999-2222",
            address: "Av. dos Cortes, 456 - Vila Nova",
            description: "Barbearia do Pablo",
          },
          {
            id: "empresaadmin@xcortes.com",
            name: "XCorte Admin",
            email: "empresaadmin@xcortes.com",
            phone: "(11) 99999-1111",
            address: "Rua das Barbearias, 123 - Centro",
            description: "Empresa Admin XCortes",
          },
        ];
        console.log("üìã Usando empresas de teste V2:", enterprises.length);
      }

      setEnterprises(enterprises);

      // Sempre sincronizar empresa com usu√°rio logado, ignorando cookie antigo se necess√°rio
      const savedEnterprise = Cookies.get("current_enterprise");
      let initialEnterprise = null;
      if (user && user.enterpriseEmail) {
        // Se usu√°rio logado, prioriza empresa do usu√°rio
        initialEnterprise = enterprises.find(
          (e) => e.email === user.enterpriseEmail
        );
        if (initialEnterprise) {
          setCurrentEnterprise(initialEnterprise);
          Cookies.set("current_enterprise", JSON.stringify(initialEnterprise), {
            expires: 30,
          });
          console.log(
            "üîÑ Empresa sincronizada com usu√°rio logado:",
            initialEnterprise
          );
        }
      } else if (savedEnterprise) {
        const enterprise = JSON.parse(savedEnterprise);
        setCurrentEnterprise(enterprise);
        console.log("üç™ Empresa carregada dos cookies:", enterprise);
      } else {
        // Usar empresa padr√£o ou primeira da lista
        const defaultEnterprise =
          enterprises.find((e) => e.email === DEFAULT_ENTERPRISE_EMAIL) ||
          enterprises[0];
        if (defaultEnterprise) {
          setCurrentEnterprise(defaultEnterprise);
          Cookies.set("current_enterprise", JSON.stringify(defaultEnterprise), {
            expires: 30,
          });
          console.log("üè¢ Definindo empresa padr√£o:", defaultEnterprise);
        }
      }
    } catch (error) {
      console.error("‚ùå Erro geral ao carregar empresas:", error);

      // √öltimo recurso: empresa padr√£o m√≠nima
      const fallbackEnterprise = {
        id: "1",
        name: "XCorte Barbearia",
        email: "test@empresa.com",
        phone: "(11) 99999-9999",
        address: "Rua das Flores, 123 - Centro",
      };

      setEnterprises([fallbackEnterprise]);
      setCurrentEnterprise(fallbackEnterprise);
      Cookies.set("current_enterprise", JSON.stringify(fallbackEnterprise), {
        expires: 30,
      });
    } finally {
      setLoading(false);
    }
  };

  const selectEnterprise = (enterprise) => {
    console.log(
      "üîÑ selectEnterprise chamado com:",
      enterprise?.name,
      enterprise?.email
    );
    console.log(
      "üîÑ Empresa atual:",
      currentEnterprise?.name,
      currentEnterprise?.email
    );
    console.log(
      "üîÑ Empresas s√£o diferentes?",
      enterprise?.email !== currentEnterprise?.email
    );

    setCurrentEnterprise(enterprise);
    Cookies.set("current_enterprise", JSON.stringify(enterprise), {
      expires: 30,
    });

    // Invalidar cache do React Query quando mudar de empresa
    if (queryClient && enterprise?.email !== currentEnterprise?.email) {
      console.log(
        "üóëÔ∏è Invalidando cache do React Query para nova empresa:",
        enterprise?.email
      );
      console.log("üóëÔ∏è QueryClient dispon√≠vel:", !!queryClient);

      // Verificar queries existentes antes da invalida√ß√£o
      const allQueries = queryClient.getQueriesData();
      console.log(
        "üìã Total de queries no cache antes da invalida√ß√£o:",
        allQueries.length
      );

      // M√©todo mais agressivo: remover queries antigas e invalidar
      try {
        // 1. Remover todas as queries de admin da empresa anterior
        if (
          currentEnterprise?.email &&
          currentEnterprise.email !== enterprise.email
        ) {
          console.log(
            "üóëÔ∏è Removendo queries da empresa anterior:",
            currentEnterprise.email
          );
          queryClient.removeQueries({
            predicate: (query) => {
              const hasOldEmail = query.queryKey.includes(
                currentEnterprise.email
              );
              if (hasOldEmail) {
                console.log(
                  "üóëÔ∏è Removendo query com email antigo:",
                  query.queryKey
                );
              }
              return hasOldEmail;
            },
          });
        }

        // 2. Invalidar todas as queries de admin
        console.log("üóëÔ∏è Invalidando todas as queries de admin...");
        const invalidateResult = queryClient.invalidateQueries({
          predicate: (query) => {
            const shouldInvalidate =
              query.queryKey.includes("admin") ||
              query.queryKey.includes("staff") ||
              query.queryKey.includes("employees") ||
              query.queryKey.includes("products") ||
              query.queryKey.includes("services") ||
              query.queryKey.includes("appointments");

            if (shouldInvalidate) {
              console.log("üóëÔ∏è Invalidando query:", query.queryKey);
            }

            return shouldInvalidate;
          },
        });

        console.log("‚úÖ Invalida√ß√£o conclu√≠da, resultado:", invalidateResult);

        // 3. For√ßar refetch das queries da nova empresa
        setTimeout(() => {
          console.log(
            "üîÑ For√ßando refetch para nova empresa:",
            enterprise.email
          );
          queryClient.refetchQueries({
            predicate: (query) => {
              const shouldRefetch =
                query.queryKey.includes("admin") &&
                query.queryKey.includes(enterprise.email);
              if (shouldRefetch) {
                console.log("üîÑ Refetch query:", query.queryKey);
              }
              return shouldRefetch;
            },
          });
        }, 200);
      } catch (error) {
        console.error("‚ùå Erro durante invalida√ß√£o do cache:", error);
      }

      // Verificar queries ap√≥s invalida√ß√£o
      setTimeout(() => {
        const queriesAfter = queryClient.getQueriesData();
        console.log(
          "üìã Total de queries no cache ap√≥s invalida√ß√£o:",
          queriesAfter.length
        );
      }, 300);
    } else if (!queryClient) {
      console.error("‚ùå QueryClient n√£o est√° dispon√≠vel para invalida√ß√£o!");
    } else {
      console.log(
        "‚ö†Ô∏è N√£o invalidando cache - empresas s√£o iguais ou n√£o h√° mudan√ßa"
      );
    }
  };

  const createEnterprise = async (_enterpriseData) => {
    // API desabilitada - usar Firestore diretamente se necess√°rio
    console.log("createEnterprise desabilitado - API n√£o dispon√≠vel");
    return { success: false, error: "Fun√ß√£o n√£o dispon√≠vel" };
  };

  const updateEnterprise = async (_email, _enterpriseData) => {
    // API desabilitada - usar Firestore diretamente se necess√°rio
    console.log("updateEnterprise desabilitado - API n√£o dispon√≠vel");
    return { success: false, error: "Fun√ß√£o n√£o dispon√≠vel" };
  };

  // Fun√ß√£o para sincronizar empresa com usu√°rio logado
  const syncEnterpriseWithUser = useCallback(
    (user) => {
      console.log("üîÑ syncEnterpriseWithUser chamado:", {
        user,
        enterprises,
        currentEnterprise,
      });

      if (!user || !user.enterpriseEmail) {
        console.log("üîÑ Usu√°rio sem enterpriseEmail, usando empresa padr√£o");
        return;
      }

      const targetEnterprise = enterprises.find(
        (e) => e.email === user.enterpriseEmail
      );

      console.log(
        "üîç Procurando empresa:",
        user.enterpriseEmail,
        "Encontrada:",
        targetEnterprise
      );

      if (
        targetEnterprise &&
        currentEnterprise?.email !== targetEnterprise.email
      ) {
        console.log(
          `üîÑ Sincronizando empresa: ${targetEnterprise.name} (${targetEnterprise.email})`
        );
        console.log(
          "üîÑ Empresa anterior:",
          currentEnterprise?.name,
          currentEnterprise?.email
        );
        console.log(
          "üîÑ Empresa nova:",
          targetEnterprise.name,
          targetEnterprise.email
        );

        setCurrentEnterprise(targetEnterprise);
        Cookies.set("current_enterprise", JSON.stringify(targetEnterprise), {
          expires: 30,
        });

        // Invalidar cache do React Query quando sincronizar automaticamente
        if (queryClient) {
          console.log(
            "üóëÔ∏è Invalidando cache do React Query para empresa sincronizada:",
            targetEnterprise.email
          );
          console.log("üóëÔ∏è QueryClient dispon√≠vel:", !!queryClient);

          // Verificar queries existentes antes da invalida√ß√£o
          const allQueries = queryClient.getQueriesData();
          console.log(
            "üìã Total de queries no cache antes da invalida√ß√£o:",
            allQueries.length
          );

          // M√©todo mais agressivo: remover queries antigas e invalidar
          try {
            // 1. Remover todas as queries de admin da empresa anterior
            if (
              currentEnterprise?.email &&
              currentEnterprise.email !== targetEnterprise.email
            ) {
              console.log(
                "üóëÔ∏è Removendo queries da empresa anterior:",
                currentEnterprise.email
              );
              queryClient.removeQueries({
                predicate: (query) => {
                  const hasOldEmail = query.queryKey.includes(
                    currentEnterprise.email
                  );
                  if (hasOldEmail) {
                    console.log(
                      "üóëÔ∏è Removendo query com email antigo:",
                      query.queryKey
                    );
                  }
                  return hasOldEmail;
                },
              });
            }

            // 2. Invalidar todas as queries de admin
            console.log("üóëÔ∏è Invalidando todas as queries de admin...");
            const invalidateResult = queryClient.invalidateQueries({
              predicate: (query) => {
                const shouldInvalidate =
                  query.queryKey.includes("admin") ||
                  query.queryKey.includes("staff") ||
                  query.queryKey.includes("employees") ||
                  query.queryKey.includes("products") ||
                  query.queryKey.includes("services") ||
                  query.queryKey.includes("appointments");

                if (shouldInvalidate) {
                  console.log("üóëÔ∏è Invalidando query:", query.queryKey);
                }

                return shouldInvalidate;
              },
            });

            console.log(
              "‚úÖ Invalida√ß√£o conclu√≠da, resultado:",
              invalidateResult
            );

            // 3. For√ßar refetch das queries da nova empresa
            setTimeout(() => {
              console.log(
                "üîÑ For√ßando refetch para nova empresa:",
                targetEnterprise.email
              );
              queryClient.refetchQueries({
                predicate: (query) => {
                  const shouldRefetch =
                    query.queryKey.includes("admin") &&
                    query.queryKey.includes(targetEnterprise.email);
                  if (shouldRefetch) {
                    console.log("üîÑ Refetch query:", query.queryKey);
                  }
                  return shouldRefetch;
                },
              });
            }, 200);
          } catch (error) {
            console.error("‚ùå Erro durante invalida√ß√£o do cache:", error);
          }

          // Verificar queries ap√≥s invalida√ß√£o
          setTimeout(() => {
            const queriesAfter = queryClient.getQueriesData();
            console.log(
              "üìã Total de queries no cache ap√≥s invalida√ß√£o:",
              queriesAfter.length
            );
          }, 300);
        } else {
          console.error("‚ùå QueryClient n√£o est√° dispon√≠vel para invalida√ß√£o!");
        }
      } else if (!targetEnterprise) {
        console.warn("‚ö†Ô∏è Empresa n√£o encontrada:", user.enterpriseEmail);
      } else {
        console.log("‚úÖ Empresa j√° est√° correta:", currentEnterprise?.name);
      }
    },
    [enterprises, currentEnterprise, queryClient]
  );

  const value = {
    currentEnterprise,
    enterprises,
    loading,
    selectEnterprise,
    createEnterprise,
    updateEnterprise,
    loadEnterprises,
    syncEnterpriseWithUser,
  };

  return (
    <EnterpriseContext.Provider value={value}>
      {children}
    </EnterpriseContext.Provider>
  );
};
